#!/bin/bash
# Text formatting variables
DF='\e[39m'
Bold='\e[1m'
Blink='\e[5m'
yell='\e[33m'
red='\e[31m'
green='\e[32m'
blue='\e[34m'
PURPLE='\e[35m'
cyan='\e[36m'
Lred='\e[91m'
Lgreen='\e[92m'
Lyellow='\e[93m'
NC='\e[0m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
LIGHT='\033[0;37m'
grenbo="\e[92;1m"

clear

# Function to convert bytes to human-readable format
function con() {
    local -i bytes=$1;
    if [[ $bytes -lt 1024 ]]; then
        echo "${bytes}B"
    elif [[ $bytes -lt 1048576 ]]; then
        echo "$(( (bytes + 1023) / 1024 ))KB"
    elif [[ $bytes -lt 1073741824 ]]; then
        echo "$(( (bytes + 1048575) / 1048576 ))MB"
    else
        echo "$(( (bytes + 1073741823) / 1073741824 ))GB"
    fi
}

# Initialize temporary file
echo -n > /tmp/other.txt

# Extract unique VMess accounts from the configuration file
data=( $(cat /etc/xray/config.json | grep '###' | cut -d ' ' -f 2 | sort | uniq) )

# Display header
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e " \e[1;97;101m           CEK VMESS ACCOUNT            \e[0m"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

# Loop through each VMess account
for akun in "${data[@]}"
do
    if [[ -z "$akun" ]]; then
        akun="tidakada"
    fi

    # Initialize temporary file for this account
    echo -n > /tmp/ipvmess.txt

    # Extract unique IPs from the logs
    data2=( $(cat /var/log/xray/access.log | tail -n 500 | cut -d " " -f 3 | sed 's/tcp://g' | cut -d ":" -f 1 | sort | uniq) )
    for ip in "${data2[@]}"
    do
        # Check if the IP matches the current account
        if grep -w "$akun" /var/log/xray/access.log | tail -n 500 | grep -w "$ip" > /dev/null; then
            echo "$ip" >> /tmp/ipvmess.txt
        fi
    done

    # Deduplicate IPs and count unique logins
    sort -u /tmp/ipvmess.txt -o /tmp/ipvmess.txt
    jum2=$(cat /tmp/ipvmess.txt | wc -l)

    # Fetch additional details for the account
    if [[ -s /tmp/ipvmess.txt ]]; then
        iplimit=$(cat /etc/kyt/limit/vmess/ip/${akun} 2>/dev/null)
        byte=$(cat /etc/vmess/${akun} 2>/dev/null)
        lim=$(con ${byte})
        wey=$(cat /etc/limit/vmess/${akun} 2>/dev/null)
        gb=$(con ${wey})
        lastlogin=$(cat /var/log/xray/access.log | grep -w "$akun" | tail -n 500 | cut -d " " -f 2 | tail -1)

        # Display account information
        echo -e " \033[1;36m┌──────────────────────────────────────┐\033[0m"
        printf "  %-13s %-7s %-8s %2s\n" "  UserName : ${akun}" | lolcat
        printf "  %-13s %-7s %-8s %2s\n" "  Login    : $lastlogin" | lolcat
        printf "  %-13s %-7s %-8s %2s\n" "  Usage Quota : ${gb}" | lolcat
        printf "  %-13s %-7s %-8s %2s\n" "  Limit Quota : ${lim}" | lolcat
        printf "  %-13s %-7s %-8s %2s\n" "  Limit IP : $iplimit" | lolcat
        printf "  %-13s %-7s %-8s %2s\n" "  Login IP : $jum2" | lolcat
        echo -e " \033[1;36m└──────────────────────────────────────┘\033[0m"
    fi

    # Cleanup temporary file for this account
    rm -rf /tmp/ipvmess.txt
done

# Cleanup global temporary file
rm -rf /tmp/other.txt

# Display footer
echo ""
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo ""
